{
    "name": "CircuitBreaker",
    "title": "@CircuitBreaker for Fault Tolerance",
    "description": "Build a fault tolerant microservice ...",
    "duration": "10 minutes",
    "audience": "developer",
    "steps": [
        {
            "name": "Intro",
            "title": "Introduction",
            "description": ["It is important to build microservices to be fault tolerant for resilience against failure. Fault tolerance is about using different strategies to ensure reduced impact and continued operation of service in the event of failure. <a href='https://microprofile.io/' target='_blank'>MicroProfile</a> makes this very simple with their fault tolerance feature.<br>",
            "In this guide, we will introduce the circuit breaker and fallback concepts and show how to implement them using the MicroProfile fault tolerance feature.<br>",
            "<action>To get started, add the <b>mpFaultTolerance-1.0</b> feature to your server.xml.</action>",
            "<pre>&lt;featureManager&gt;",
                "\t&lt;feature&gt;mpFaultTolerance-1.0&lt;/feature&gt;",
            "&lt;/featureManager&gt;</pre>"],
            "displayType": "none"
        },
        {
          "name": "Background",
          "title": "Background Concepts",
          "description": ["We will be using MicroProfile's <b>@CircuitBreaker</b> and <b>@Fallback</b> policies for our fault tolerance implementation.<br>",
          "<b>@CircuitBreaker</b> allows us to fail fast by automatically failing executions to prevent system overload, indefinite wait, or client timeout.",
          "<b>@Fallback</b> provides an alternate solution for the failed execution."],
          "displayType": "none",
          "steps": [
            {
              "name": "CircuitBreaker",
              "title": "Circuit Breaker",
              "description": [
                  "The circuit breaker design pattern allows your microservice to fail immediately to prevent repeated executions that are likely to fail.<br>",
                  "The software circuit breaker operates much like an electrical circuit breaker. A <b>closed</b> circuit represents a fully functional system, and an <b>open</b> circuit represents an incomplete system. In the event of failure, the circuit breaker triggers to open the circuit, removing the point of failure from the system.<br>",
                  "In a software circuit breaker, there is an additional <b>half-open</b> state. Once the circuit is opened, it will periodically transition to the half-open state, where it will check if the failed component is restored and close the circuit once it is considered safe and functional."
                ],
                "content": [
                  {
                    "displayType":"pod",
                    "content": "../../../html/guides/circuitBreaker/CircuitBreakerStateDiagram.html"
                  }
                ]
            },
            {
              "name": "Fallback",
              "title": "Fallback",
              "description": [
                "A fallback service runs when the main service fails. When used in conjunction with other fault tolerant design patterns, a fallback can provide graceful failure or continued or partial operation of the original service.<br>",
                "In our example, we will be using a fallback with a circuit breaker. When the main service fails and triggers the circuit breaker to open the circuit, subsequent requests for the service will be routed to the fallback service until the main service is restored."
              ]
            }
          ]
        },
        {
            "name": "Scenario",
            "title": "Example: Bank Scenario",
            "description": [
                "Imagine that your online banking application has many different microservices:",
                "<div style='display: inline-block;margin: 5px 25px;'>a service for checking your balance, a service for transferring money, a service for depositing money, and a balance snapshot service used as a backup of data.</div>",
                "On the next step, you will try to check your balance on the bank's website."
            ],
            "content": [
              {
                "displayType":"pod",
                "content": "<div><img src='../../../html/guides/circuitBreaker/images/BankScenario.png' alt='Online Banking Microservices' width='600' height='200'></div>"
              }
            ],
            "steps": [
                {
                    "name": "CheckBalance",
                    "title": "Check Your Balance",
                    "description": [
<<<<<<< HEAD
                      "Visit your bank's website by typing or click on <action tabindex='0' title='url' 'role'='button' aria-label='url' id='populate_url' onclick=\"circuitBreakerCallBack.populate_url('CheckBalance')\"><b>http://localhost:9080/RestServicesSamples/banking/checkBalance</b></action> into the browser URL and then press <b>Enter</b>."
=======
                      "Visit your bank's website to check your current balance before heading out for a night on the town.</br>",
                      "Enter the following url into the browser below by typing or clicking on <action tabindex='0' title='url' aria-label='url' id='populate_url' onclick=\"circuitBreakerCallBack.populate_url('CheckBalance')\"><b>http://localhost:9080/RestServicesSamples/banking/checkBalance</b></action> and then press <b>Enter</b>."
>>>>>>> 529cd06114d4355f90a240bcbaab08d64e941631
                    ],
                    "content":[
                      {
                        "displayType":"webBrowser",
                        "url": "",
                        "browserContent": "",
                        "callback": "(function test(webBrowser) {circuitBreakerCallBack.listenToBrowserForFailBalance(webBrowser); })"
                      },
                      {
                        "displayType":"pod"
                      }
                    ]
                }
            ]
        },
        {
            "name": "AfterAddCircuitBreakerAnnotation",
            "title": "Add @CircuitBreaker Annotation",
            "description": [
                "Let us add a default @CircuitBreaker policy to the Check Balance microservice.",
                "<br/><instruction>Type the @CircuitBreaker annotation on line 6 above the Check Balance service:</code><action tabindex='0' 'role'='button' aria-label='Circuite Breaker Annotation' title='Circuit Breaker Annotation' onclick=\"circuitBreakerCallBack.addCircuitBreakerAnnotation('AfterAddCircuitBreakerAnnotation')\"><b>@CircuitBreaker()</b></action>",
                "<code>Click the <b>save button</b> on the upper left of the editor menu pane.<instruction><br/>"
            ],
            "content":[
              {
                "displayType":"fileEditor",
                "fileName": "BankService.java",
                "preload": [
                    "package com.ibm.websphere.restexamples;",
                    "import javax.ws.rs.GET;",
                    "import javax.ws.rs.Path;",
                    "",
                    "public class BankService {",
                    "",
                    "    public Service checkBalance() {",
                    "        counterForInvokingBankingService++;",
                    "        return checkBalanceService();",
                    "    }",
                    "}"
                ],
                "readonly": false,
                "save": true,
                "callback": "(function test(editor) {circuitBreakerCallBack.listenToEditorForCircuitBreakerAnnotation(editor); })"
              },
              {
                "displayType":"pod"
              }
            ],
            "steps": [
              {
                "name": "ConfigureFailureThresholdParams",
                "title": "Configure Failure Threshold",
                "description": [
                  "The default @CircuitBreaker policy triggers when 10 calls to the microservice fail in a rolling window of 20 attempts. You can change the failure threshold by using these two parameters in @CircuitBreaker.<br/>",
                  "<ul><li><b>requestVolumeThreshold:</b> The size of the rolling window used to determine the failure threshold. The default is 20.",
                  "<li><b>failureRatio:</b> The minimum failure ratio in the rolling window to trigger the circuit breaker. It is used in conjunction with the requestVolumeThreshold value. For example, if the requestVolumeThreshold is 20 and the failureRatio is 0.5, 10 failures in 20 consecutive requests will trigger the circuit to open. The default is 0.5.",
                  "</ul><br/>Suppose we change the default @CircuitBreaker annotation to",
                  "<pre>@CircuitBreaker(requestVolumeThreshold=4,failureRatio=0.25)</pre>",
                  "<code>Click on the <b>refresh button</b> in the browser</code> to see how the above annotation affects the Check Balance call.<br/>"
                ],
                "content":[
                  {
                    "displayType":"webBrowser",
                    "url": "http://localhost:9080/RestServicesSamples/banking/checkBalance",
                    "callback": "(function test(webBrowser) {circuitBreakerCallBack.listenToBrowserForFailBalance(webBrowser); })"
                  },
                  {
                    "displayType":"pod"
                  }
                ]
              },
              {
                "name": "ConfigureDelayParams",
                "title": "Configure Delay",
                "description": [
                    "By default, the circuit will remain in the open state for 5000 ms before transitioning to the half-open state. The delay parameter allows you to customize the length of the delay.",
                    "<br/><b>delay:</b> The delay in milliseconds to transition to a half-open state after the circuit is open.",
                    "<br/>Suppose we change the @CircuitBreaker annotation shorten the delay.",
                    "<pre>@CircuitBreaker(requestVolumeThreshold=4,failureRatio=0.25,delay=3000)</pre>",
                    "<code>Click on the <b>refresh button</b> in the browser</code> to see how the above annotation affects the Check Balance call.<br/>"
                ],
                "content":[
                  {
                    "displayType":"webBrowser",
                    "url": "http://localhost:9080/RestServicesSamples/banking/checkBalance",
                    "browserContent": "Replace with pod container",
                    "callback": "(function test(webBrowser) {circuitBreakerCallBack.listenToBrowserForFailBalance(webBrowser); })"
                  },
                  {
                    "displayType":"pod"
                  }
                ]
            },
            {
              "name": "ConfigureSuccesThreshold",
              "title": "Configure Success Threshold",
              "description": [
                  "When the circuit is half-open, it allows requests through to the microservice, immediately stopping and returning to the open state if one fails. If a specified number of consecutive requests succeed, the microservice is deemed healthy and the circuit will close.",
                  "The default number of consecutive successes needed is 1, and can be adjusted with the successThreshold parameter.",
                  "<br/><b>successThreshold:</b> The number of consecutive successful invocations of the service required before closing the circuit.",
                  "<br/>Suppose we change the @CircuitBreaker annotation to require 2 successful requests.",
                  "<pre>@CircuitBreaker(requestVolumeThreshold=4,failureRatio=0.25,delay=3000,successThreshold=2)</pre>",
                  "<code>Click on the <b>refresh button</b> in the browser</code> to see the Check Balance call succeed in a half-open circuit.",
                  "<code>Click on the <b>refresh button</b> again in the browser</code> to see the Check Balance call succeed in a half-open circuit."
              ],
              "content":[
                  {
                    "displayType":"webBrowser",
                    "url": "http://localhost:9080/RestServicesSamples/banking/checkBalance",
                    "browserContent": "Replace with pod container",
                    "callback": "(function test(webBrowser) {circuitBreakerCallBack.listenToBrowserFromHalfOpenCircuit(webBrowser); })"
                  },
                  {
                    "displayType":"pod"
                  }
              ]
            }
          ]
        },
        {
            "name": "AddFallBack",
            "title": "Add @Fallback Annotation",
            "description": [
              "Using the @Fallback annotation, add a fallback service that will execute when the Check Balance microservice is down and the circuit is in an open state. The fallback service will invoke the bank's Balance Cache mircroservice to return a cached value of the user's balance.",
              "<br/><font color='blue'>Proceed by adding an annotation to line 6 above the @CircuitBreaker annotation: </font>",
              "<action tabindex='0' 'role'='button' aria-label='Fallback Annotation' title='Fallback Annotation' onclick=\"circuitBreakerCallBack.addFallbackAnnotation('AddFallBack')\"><b>@Fallback (fallbackMethod = \"fallbackService\")</b></action>",
              "<font color='blue'>Add the following method to the bottom of the class:</font>",
              "<action 'role'='button' aria-label='Fallback method' title='Fallback method' onclick=\"circuitBreakerCallBack.addFallbackMethod('AddFallBack')\"><b>private Service fallbackService() {</b>",
              "<b>      return lastKnownBalance();</b>",
              "<b>}</b></action>",              
              "and then <font color='blue'>click the <b>save button</b></font>."
            ],
            "content":[
              {
                "displayType":"fileEditor",
                "fileName": "BankService.java",
                "preload": [
                    "package com.ibm.websphere.restexamples;",
                    "import javax.ws.rs.GET;",
                    "import javax.ws.rs.Path;",
                    "",
                    "public class BankService {",
                    "",
                    "    @CircuitBreaker (successThreshold=4,requestVolumeThreshold=1,failureRatio=1,delay=1000)\"",
                    "    public Service checkBalance() {",
                    "        counterForInvokingBankingService++;",
                    "        return BankingService();",
                    "    }",
                    "}"
                ],
                "readonly": "false",
                "save": true,
                "callback": "(function test(editor) {circuitBreakerCallBack.listenToEditorForFallbackAnnotation(editor); })"
              },
              {
                "displayType":"pod"
              }
            ],
            "steps": [
              {
                "name": "fallbackService",
                "title": "Fallback Service",
                "description": [
                  "Click on the <b>refresh button</b> in the browser.<br/>",
                  "Since the circuit is in open state, the bank's Check Balance microservice will fail right away and the fallback service will be executed. The circuit will transition to half-open after the delay."
                ],
                "content":[
                  {
                    "displayType":"webBrowser",
                    "url": "http://localhost:9080/RestServicesSamples/banking/checkBalance",
                    "callback": "(function test(webBrowser) {circuitBreakerCallBack.listenToBrowserForFallbackSuccessBalance(webBrowser); })"
                  },
                  {
                      "displayType":"pod"
                  }
                ]
            }
            ]
        },

        {
            "name": "playground",
            "title": "Configure your own Circuit Breaker",
            "description": [
              "Now that you have learned about circuit breakers and fallbacks, you can play with the parameters in the @CircuitBreaker annotation and see the circuit in action.",
              "Here is a recap of the parameters:",
              "",
              "<b>requestVolumeThreshold</b>: The size of the rolling window used to determine the failure threshold. The default is 20.",
              "<b>failureRatio</b>: The minimum failure ratio in the rolling window to trigger the circuit breaker. The default is 0.5.",
              "<b>delay</b>: The delay in milliseconds to transition to a half-open state after the circuit is open. The default is 5000ms.",
              "<b>successThreshold</b>: The number of consecutive successful invocations of the service required before closing the circuit. The default is 1.",
              "",
              "<b>Modify the parameters for the Circuit Breaker annotation and click save</b> to see the Circuit Breaker configured by your parameters.",
              "After you change the annotation, you can simulate successful or failed requests to the microservice to see how the circuit state changes."
            ],
            "content":[
              {
                "displayType":"fileEditor",
                "fileName": "BankService.java",
                "preload": [
                    "package com.ibm.websphere.restexamples;",
                    "import javax.ws.rs.GET;",
                    "import javax.ws.rs.Path;",
                    "",
                    "public class BankService {",
                    "",
                    "    @CircuitBreaker(requestVolumeThreshold=4,",
                    "                     failureRatio=.5,",
                    "                     delay=3000,",
                    "                     successThreshold=4)",
                    "    public Service checkBalance() {",
                    "        counterForInvokingBankingService++;",
                    "        return BankingService();",
                    "    }",
                    "}"
                ],
                "readonly": [
                    {
                        "from": "1",
                        "to": "6"
                    },
                    {
                        "from": "11",
                        "to": "15"
                    }
                ],
                  "save": true,
                  "callback": "(function test(editor) {circuitBreakerCallBack.listenToEditorForCircuitBreakerAnnotationChanges(editor); })"
                },
                {
                  "displayType":"pod",
                  "content": "../../../html/guides/circuitBreaker/circuitBreakerPlayground.html"
                }
              ]
        },
        {
            "name": "WhatNext",
            "title": "What's Next",
            "description": "Congratulations, you have learned how to use a circuit breaker and provide a fallback to make your microservice fault tolerant."
        }
    ]
}
