{
    "name": "CircuitBreaker",
    "title": "Circuit Breaker Guide",
    "description": "Build a fault tolerant microservice ...",
    "duration": "10 minutes",
    "audience": "developer",
    "steps": [
        {
            "name": "Intro",
            "title": "Introduction",
            "description": "Building a fault tolerant microservice is important so that it is resilient in the case of failure. If a  microservice fails, then it is important to have a circuit breaker to prevent unsuccessful attempts. If the retry fails, then the microservice should have a fallback solution to execute.",
            "displayType": "none"
        },
        {
            "name": "Scenario",
            "title": "Bank Scenario",
            "description": [
                "Imagine that your bank has many different microservices:",
                "A service for checking your balance, a service for withdrawing money, a service for depositing money, and a cache service to use for backup.",
                "On the next step, you will try to check your balance on the bank's website."
            ],
            "content": [
              {
                "displayType":"pod",
                "content": "<div><img src='../../../html/guides/circuitBreaker/Images/BankScenario.png' alt='Online Banking Microservices' width='600' height='200'></div>"
              }
            ],
            "steps": [
                {
                    "name": "CheckBalance",
                    "title": "Check Balance",
                    "description": [
                      "Visit your bank's website by typing http://localhost:9080/RestServicesSamples/banking/checkBalance into the browser URL and then press enter."
                     ],
                    "content":[
                      {
                        "displayType":"webBrowser",
                        "url": "",
                        "browserContent": "",
                        "callback": "(function test(webBrowser) {circuitBreakerCallBack.listenToBrowserForFailBalance(webBrowser); })"
                      },
                      {
                        "displayType":"pod"
                      }
                    ]
                }
            ]
        },
        {
            "name": "CircuitBreaker",
            "title": "Circuit Breaker",
            "description": [
                "A circuit breaker allows your microservice to fail immediately when it is down so additional attempts will not have to wait to know that it is down.",
                "A circuit will remain closed and run the microservice until it fails.",
                "When the service fails, the circuit goes into an open state for a set delay period and any attempt to call the service will fail immediately.",
                "After the delay, the circuit switches to a half-opened state. It will allow requests to the main service again and take <successThreshold> successful attempts before the circuit is closed again.",
                "If it fails before then, the circuit goes back into an open state and is down for the set delay. TODO: add in image of circuit below"
            ],
            "content": [
              {
                "displayType":"pod",
                "content":"(pod showing the diagram of 3 circuit breaker states)"
              }
            ],
            "steps": [
              {
                  "name": "AfterAddCircuitBreakerAnnotation",
                  "title": "Add Circuit Breaker Annotation",
                  "description": [
                      "Add a circuit breaker annotation to the bank's checkBalance microservice to enable the circuit breaker.",
                      "Type in \"@CircuitBreaker (successThreshold=4,requestVolumeThreshold=1,failureRatio=1,delay=1000)\" above the checkBalance method",
                      "then click the save button.",
                      "",
                      "The  circuit will open again when 1 (1 requestVolumeThreshold x1.00 failureRatio) failure occurs among the rolling window of 1 consecutive invocations.",
                      " The circuit will stay open for 1000ms and then transition to half open.",
                      "After 4 successful invocations, the circuit will be back to close again."
                  ],
                  "content":[
                    {
                      "displayType":"fileEditor",
                      "fileName": "BankService.java",
                      "preload": [
                          "package com.ibm.websphere.restexamples;",
                          "import javax.ws.rs.GET;",
                          "import javax.ws.rs.Path;",
                          "",
                          "public class BankService {",
                          "",
                          "    public Service checkBalance() {",
                          "        counterForInvokingBankingService++;",
                          "        return checkBalanceService();",
                          "    }",
                          "}"
                      ],
                      "readonly": false,
                      "save": true,
                      "callback": "(function test(editor) {circuitBreakerCallBack.listenToEditorForCircuitBreakerAnnotation(editor); })"
                    },
                    {
                      "displayType":"pod"
                    }                    
                  ]
              },
              {
                  "name": "OpenCircuit",
                  "title": "Open Circuit",
                  "description": [
                      "If a failure occurs, the circuit breaker keeps a record.",
                      "Click on the refresh button in the browser.",
                      "Since the checkBalance microservice is still down, a failure is returned. After 1 failure is reached, the circuit is now in open state so any future attempt to connect to the checkBalance service will return immediately without waiting."
                  ],
                  "content":[
                    {
                      "displayType":"webBrowser",
                      "url": "http://localhost:9080/RestServicesSamples/banking/checkBalance",
                      "browserContent": "Replace with pod container",
                      "callback": "(function test(webBrowser) {circuitBreakerCallBack.listenToBrowserForFailBalance(webBrowser); })"
                    },
                    {
                      "displayType":"pod"
                    }
                  ]
              }
            ]
        },
        {
            "name": "Fallback",
            "title": "Fallback",
            "description": "A fallback is another microservice that runs when your main service fails. In conjunction with a circuit breaker, a fallback is used for the whole delay while the circuit is in the open state and any requests that come to the main service are diverted to the fallback.",
            "steps": [
              {
                  "name": "AddFallBack",
                  "title": "Add Fallback",
                  "description": [
                    "You will add a fallback service named cachedService that will run whenever the checkBalance service is down and the circuit is in an open state.",
                    "Proceed by adding an annotation to line 6 above the @CircuitBreaker annotation: ",
                    "@Fallback (fallbackMethod = \"fallbackService\")",
                    "",
                    "Add the following method to the bottom of the class:",
                    "public Service fallbackService() {",
                    "        return cachedService();",
                    "}",
                    "and then click save."
                  ],
                  "content":[
                    {
                      "displayType":"fileEditor",
                      "fileName": "BankService.java",
                      "preload": [
                          "package com.ibm.websphere.restexamples;",
                          "import javax.ws.rs.GET;",
                          "import javax.ws.rs.Path;",
                          "",
                          "public class BankService {",
                          "",
                          "    @CircuitBreaker (successThreshold=4,requestVolumeThreshold=1,failureRatio=1,delay=1000)\"",
                          "    public Service checkBalance() {",
                          "        counterForInvokingBankingService++;",
                          "        return BankingService();",
                          "    }",
                          "}"
                      ],
                      "readonly": "false",
                      "save": true,
                      "callback": "(function test(editor) {circuitBreakerCallBack.listenToEditorForFallbackAnnotation(editor); })"
                    },
                    {
                      "displayType":"pod"
                    }
                  ]
              },
              {
                  "name": "cachedService",
                  "title": "Cache Service",
                  "description": [
                    "Click on the refresh button in the browser.",
                    "Since the circuit is opened, the service will fail right away but the fallback service will be executed. The circuit will become half-open after the delay.",
                    "(pod sliding in to show a half-open circuit breaker with fallback after refresh is returned showing the balance)"
                  ],
                  "content":[
                    {
                      "displayType":"webBrowser",
                      "url": "http://localhost:9080/RestServicesSamples/banking/checkBalance",
                      "callback": "(function test(webBrowser) {circuitBreakerCallBack.listenToBrowserForFallbackSuccessBalance(webBrowser); })"
                    }
                  ]
              }
            ]
        },
        {
            "name": "HalfOpenCloseCircuit",
            "title": "Half-open to Closed Circuit",
            "description": "In a half-open circuit, one call to the circuit is allowed. If it fails, the circuit will remain open. Otherwise, subsequent calls are allowed. After four successful execution per our circuitBreaker annotation, the circuit will be closed.",
            "steps": [
              {
                  "name": "closeCircuit",
                  "title": "Transition to Closed Circuit",
                  "description": [
                    "Since the circuitBreaker is in half-open state, three check balance transations have run successfully using the checkBalance microservice.",
                    "Now click on the refresh button in the browser.",
                    "The service runs successfully. Since this is the fourth successful calls, the circuit is now closed.",
                    "(pod sliding in to show a closed circuit breaker with fallback after refresh is returned showing the balance)"
                  ],
                  "content":[
                    {
                      "displayType":"webBrowser",
                      "url": "http://localhost:9080/RestServicesSamples/banking/checkBalance",
                      "callback": "(function test(webBrowser) {circuitBreakerCallBack.listenToBrowserForSuccessBalance(webBrowser); })"
                    }
                  ]
              }
            ]
        },
        {
            "name": "playground",
            "title": "Test configuring your own Circuit Breaker",
            "description": [
              "Since you've learned what a circuit breaker and a fallback are, now you can test configuring the parameters in the circuit breaker annotation and watch the circuit get updated live.",
              "Modify the 4 different parameters above the checkBalance service.",
              "Here's a recap of what the parameters mean:",
              "successThreshold: How many requests need to be successful while in half-open state to switch to closed state.",
              "requestVolumeThreshold: The window of requests that can fail before the circuit switches from closed to open.",
              "failureRatio: What percentage of the requestVolumeThreshold requests need to fail before the circuit switches from closed to open state.",
              "delay: How long the circuit stays in the open state before switching to the half-open state.",
              "TODO: Add the circuit pod and the code editor / buttons for letting them make the next request succeed or fail."
            ]
        },
        {
            "name": "WhatNext",
            "title": "What's Next",
            "description": "Congratulations, you have learned how to use a circuit breaker and provide a fallback to make your microservice fault tolerant."
        }
    ]
}
